# ERCP Base Field Definitions
# This is the BASE for all ERCP subtypes - defines common fields shared across all ERCPs

# Metadata about this procedure type
meta:
  procedure_group: ercp
  title: Endoscopic Retrograde Cholangiopancreatography 

# Common field groups for ALL ERCP procedures
field_groups:
  patient_demographics: # Headers at this indentation level are logically-grouped sections. This one corresponds to "INDICATIONS" in the template Word docs
    description: "Basic patient information (common to all ERCPs)"
    report_section: "indications"
    template: |
    fields:
      - name: age
        type: integer
        prompt_instruction: "patient age as integer"
        required: true
        
      - name: sex
        type: string
        prompt_instruction: "male or female"
        required: true
        
      - name: chief_complaints
        type: string
        prompt_instruction: "Main symptoms, indications, or reasons for the procedure"
        required: true

  patient_history:
    description: "Patient medical and social history"
    report_section: "history"
    template: |
    fields:
      - name: symptoms_duration
        type: string
        prompt_instruction: "Duration of symptoms if mentioned, e.g. '3 months'"
        
      - name: symptoms_description
        type: string
        prompt_instruction: "Detailed description of symptoms if mentioned"
        
      - name: negative_history
        type: string
        prompt_instruction: "Any negative history mentioned"
        
      - name: past_medical_history
        type: string
        prompt_instruction: "If none mentioned, record 'none'"
        
      - name: current_medications
        type: string
        prompt_instruction: "current medications if mentionsed"
        
      - name: family_history
        type: string
        prompt_instruction: "family history if mentioned"
        
      - name: social_history
        type: string
        prompt_instruction: "social history if mentionsed"

  procedure_description:
    description: "Equipment and procedure specifics"
    report_section: "description_of_procedure"
    template: |
    fields:
      - name: duodenoscope_type
        type: string
        prompt_instruction: "duodenoscope type used, e.g. TJF-Q180V, TJF-Q190V, ED-530XT"

  quality_metrics:
    description: "ERCP quality and technical details"
    report_section: "ercp_quality_metrics"
    template: |
      Difficulty of ERCP: Grade {{ grade_of_ercp | skip_unknown }}; pancreatic duct cannulation {{ pd_cannulation | skip_unknown }}.
    fields:
      - name: grade_of_ercp
        type: string
        prompt_instruction: "ERCP difficulty grade (1, 2, 3, or 4)"
        
      - name: pd_cannulation
        type: string
        prompt_instruction: "pancreatic duct cannulation status, e.g. 'not attempted', 'successful', 'unsuccessful'"
      
      - name: cannulation_success
        type: boolean
        prompt_instruction: "if intent was biliary cannulation and bile duct cannulated; yes/no"
        
      - name: lactated_ringers
        type: boolean
        prompt_instruction: "yes/no"
        
      - name: rectal_indomethacin
        type: boolean
        prompt_instruction: "yes/no"
        
      - name: successful_completion_of_intended_procedure
        type: boolean
        prompt_instruction: "yes/no"
        
      - name: failed_ercp_from_another_facility_or_provider
        type: boolean
        prompt_instruction: "yes if it was, else no"

  scout_film:
    description: "Abdominal scout film findings"
    report_section: "findings"
    report_subsection: "scout_film"
    template: |
    fields:
      - name: scout_film_status
        type: enum
        enum_values: ["obtained_normal", "obtained_abnormal", "not_obtained"]
        prompt_instruction: "'obtained_normal', 'obtained_abnormal', or 'not_obtained'"
        
      - name: scout_film_findings
        type: string
        prompt_instruction: "If scout film obtained and abnormal, list findings such as 'surgical clips in the RUQ', 'pneumobilia', 'biliary stent in situ', 'surgical drain', or 'residual contrast from prior study'. If normal or not obtained, record 'none'"

  scope_advancement:
    description: "Scope advancement"
    report_section: "findings"
    report_subsection: "scope_advancement"
    template: |
    fields:
      - name: scope_advancement_difficulty
        type: enum
        enum_values: ["easy", "difficult"]
        prompt_instruction: "'easy' or 'difficult'"

      - name: scope_advancement_difficulty_reason
        type: string
        prompt_instruction: "Only if scope_advancement_difficulty is 'difficult'. Describe reason for difficulty and outcome in this format: '[tortuosity/redundancy/diverticulum] but [achieved successfully / failed and procedure was aborted].'"
      
      - name: upper_gi_examination
        type: enum
        enum_values: ["detailed", "limited"]
        prompt_instruction: "'detailed' or 'limited'"
      
      - name: upper_gi_findings
        type: string
        prompt_instruction: "Record 'normal' if normal. Else list findings/abnormalities such as periampullary diverticulum, duodenal edema, ulceration, or post-surgical anatomy (Billroth II, Roux-en-Y, or Whipple reconstruction)."
  
  esd:
    description: "Esophagus, stomach, duodenum findings"
    report_section: "findings"
    template: |
    fields:
      - name: esophagus_findings
        type: string
        prompt_instruction: "'Normal on limited views' if normal. Else include measurements and specific findings."

      - name: stomach_findings
        type: string
        prompt_instruction: "'Normal on limited views' if normal. Else include measurements and specific findings."
    
      - name: duodenum_findings
        type: string
        prompt_instruction: "'Normal on limited views' if normal. Else include measurements and specific findings."

  other_findings:
    description: "Cannulation and sphincterotomy findings"
    report_section: "findings"
    report_subsection: "ercp_findings"
    template: |
    fields:
      - name: sphincterotome_type
        type: string
        prompt_instruction: "e.g. CleverCut3V / Autotome RX / Dreamtome / Hydratome / Fusion OMNI"

      - name: guidewire_type
        type: string
        prompt_instruction: "type of guidewire used to preload the sphincterome, e.g. HydraJag 0.035 or 0.025 inch / VisiGlide 2 / Dreamwire / Jagwire / Tracer Metro"

      - name: bile_duct_findings
        prompt_instruction: "If normal, record 'normal'. If failed, record 'failed, procedure aborted' or 'failed, procedure staged for repeat attempt'. If difficult, describe the procedure required, e.g. double-wire technique, pancreatic guidewire, etc."

      - name: pd_entry
        type: boolean
        prompt_instruction: "whether PD entry occured, true/false"

      - name: biliary_sphincterotomy
        type: string
        prompt_instruction: "If performed, 'true'. If not performed, record reason, e.g. prior wide opening / anticoagulation / planned diagnostic cholangioscopy only"

      - name: biliary_sphincterotomy_size
        type: integer
        prompt_instruction: "If performed, size of biliary sphincterotomy in millimeters, as an integer"

      - name: hemostasis_status
        type: boolean
        prompt_instruction: "whether there was hemostasis, true/false"

      - name: bleeding_treatment
        type: string
        prompt_instruction: "if there was bleeding, what this was treated with, e.g. 1:10 000 epinephrine (1-3 mL) / soft coagulation / clip. If no bleeding, 'none'"

  blood_loss:
    description: "Estimated blood loss"
    report_section: "findings"
    report_subsection: "blood_loss"
    template: |
    fields:
      - name: estimated_blood_loss
        type: float
        prompt_instruction: "estimated blood loss in ml, as a number. -1 if not mentioned"

  specimens_removed:
    description: "Specimens removed"
    report_section: "findings"
    report_subsection: "specimens"
    template: |
    fields:
      - name: specimens_removed
        type: string
        prompt_instruction: "Details/findings if any, else 'none'"
        
  complications:
    description: "Complications from procedure"
    report_section: "findings"
    report_subsection: "complications"
    template: |
    fields:
      - name: complications
        type: string
        prompt_instruction: "Details/findings if any, else 'none'"
  