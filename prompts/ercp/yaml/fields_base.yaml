# ERCP Base Field Definitions
# This is the BASE for all ERCP subtypes - defines common fields shared across all ERCPs

# System-level instructions (shared by all ERCP subtypes)
#TODO repeat some of these at the end of prompt
system_instructions: |
  I am giving you a transcript from an ERCP procedure. The task is to extract procedure entities. 
  Make sure you are accurate and complete. The information you extract will be used to fill a structured procedure note template.
  If examples of the template are given, ensure your extracted field fits with that structure. For instance, field "scope_advancement_difficulty_reason" will be used to fill in the template sentence "Scope advancement was challenging due to {scope_advancement_difficulty_reason}", so your answer should be a phrase that fits in that sentence.
  If examples of valid responses are given, you may also write free text responses outside those examples, unless otherwise specified. Just ensure any free text responses have the same grammatical structure as the examples.
  Not all fields may be mentioned in the transcript or applicable for the procedure. Unless explicitly otherwise specified, if you do not know the answer, record "unknown". If it wasn't mentioned or if not applicable, record "none". Do not make up information.

# Metadata about this procedure type
meta:
  procedure_group: ercp
  procedure_type: ercp_base
  title: Endoscopic Retrograde Cholangiopancreatography
  version: "1.0.1"

# Common field groups for ALL ERCP procedures
field_groups:
  indications:
    # xxxx -year-old male / female patient is here for an ERCP procedure for the evaluation of [chief complaints]
    description: "Patient demographics, in indications"
    report_section: "indications"
    template: |
      {{ age }}-year-old {{ sex }} patient is here for an ERCP procedure {% if chief_complaints | sku %}for {{ chief_complaints | sku | lower }}{% endif %}.
    fields:
      - name: age
        type: integer
        prompt_instruction: "patient age as integer"
        
      - name: sex
        type: string
        prompt_instruction: "male, female, other, or unknown"
        
      - name: chief_complaints
        type: string
        prompt_instruction: "State all main symptoms, indications, or reasons for the procedure, e.g. 'the evaluation and treatment of bile duct stricture'"

  patient_history:
    description: "Patient medical and social history"
    report_section: "history"
    template: |
      The patient reports {{ symptoms_duration | sku }} history of {{ chief_complaints | lower | sku }}.
      {{ symptoms_narrative | sku | sent }}
      {% if negative_history | sku %}No history of {{ negative_history | sku }} is reported unless otherwise specified.{% endif %}
      {% if past_medical_history | sku %}{{ past_medical_history | sku | sent }}{% endif %} {% if current_medications | sku %} Current medications include {{ current_medications | sku }}.{% endif %}
      {% if family_history | sku %}{{ family_history | sku | sent }}{% endif %} {% if social_history | sku %}{{ social_history | sku | sent }}{% endif %}
    fields:
      - name: symptoms_duration
        type: string
        prompt_instruction: "Duration of symptoms if mentioned, e.g. '3 months'"
        
      - name: symptoms_narrative
        type: string
        prompt_instruction: "Describe symptoms in detail as complete sentence, e.g. 'Patient's stributre was initially thought to be malignant; however, given negative biopsies this was felt to be benign.'"
        
      - name: negative_history
        type: string
        prompt_instruction: "Relevant negative history if mentioned. Will be used as 'No history of {{negative_history}} is reported'"
        
      - name: past_medical_history
        type: string
        prompt_instruction: "Describe past non-negative medical history as sentence(s)"
        
      - name: current_medications
        type: string
        prompt_instruction: "Describe current medications as sentence(s)"
        
      - name: family_history
        type: string
        prompt_instruction: "Describe family history as sentence(s)"
        
      - name: social_history
        type: string
        prompt_instruction: "Describe social history as sentence(s) only if non-negative social history is mentioned"

  medications:
    description: "Medications with default"
    report_section: "medications"
    template:  |
      {{ medications | default_if_unknown('Refer to record of source.') }}
    fields:
      - name: medications
        type: string
        prompt_instruction: "If specific medications are mentioned, include them with doses if available, else 'unknown"

  monitoring:
    description: "Monitoring with default"
    report_section: "monitoring"
    template: |
      {{ monitoring | default_if_unknown('Johns Hopkins Standard.') }}
    fields:
      - name: monitoring
        type: string
        prompt_instruction: "If the transcript describes monitoring, include details, else 'unknown'"

  procedure_description:
    description: "Equipment and procedure specifics"
    report_section: "description_of_procedure"
    template: |
      {% set scope_type = duodenoscope_type | default('') | sku %}
      After the risks, benefits and alternatives of the procedure were thoroughly explained, informed consent was verified, confirmed and timeout was successfully executed by the treatment team. With the patient in the left semi-prone position, medications were administered intravenously. The duodenoscope {% if scope_type %}{{ scope_type }} {% endif %}was passed from the mouth into the esophagus and further advanced from the esophagus into the stomach. From the stomach, the scope was directed to the second portion of the duodenum.
    fields:
      - name: duodenoscope_type
        type: string
        prompt_instruction: "duodenoscope type used, e.g. TJF-Q180V, TJF-Q190V, ED-530XT"

  quality_metrics:
    #DIFFICULTY OF ERCP: Grade xx;  Pancreatic duct (cannulated or no)
    #CANNULATION SUCCESS: If intent was biliary cannulation and bile duct cannulated: Yes / No 
    #POST-ERCP PANCREATITIS PROPHYLAXIS: Lactated ringers: Yes / No refer to record 
    #RECTAL INDOMETHACIN: Yes / No 
    #SUCCESSFUL COMPLETION OF INTENDED PROCEDURE: Yes / No 
    #WAS THIS A FAILED ERCP FROM ANOTHER FACILITY OR PROVIDER: Yes / No 
    description: "ERCP quality and technical details"
    report_section: "ercp_quality_metrics"
    template: |
      Difficulty of ERCP: {% if grade_of_ercp | sku %}
      Grade {{ grade_of_ercp }}.
      {% endif %}
      {% if pd_cannulation_status | sku %}
      Pancreatic duct cannulation {{ pd_cannulation_status | sent }}
      {% endif %}
      {% if cannulation_success is defined %}Cannulation success: {% if cannulation_success %}Yes{% else %}No{% endif %}.
      {% endif %}
      {% if lactated_ringers is defined %}
      Post-ERCP pancreatitis prophylaxis: {% if lactated_ringers %}Lactated ringers: Yes, refer to record of source{% else %}No{% endif %}.
      {% endif %}
      {% if rectal_indomethacin is defined %}Rectal indomethacin: {% if rectal_indomethacin %} Yes{% else %}No{% endif %}.
      {% endif %}
      {% if successful_completion is defined %}Successful completion of intended procedure: {% if successful_completion %}Yes{% else %}No{% endif %}.
      {% endif %}
      {% if failed_ercp is defined %}
      Failed ERCP from another facility or provider: {% if failed_ercp %}Yes{% else %}No{% endif %}.{% endif %}
    fields:
      - name: grade_of_ercp
        type: integer
        prompt_instruction: "ERCP difficulty grade as a integer (1, 2, 3, 4), or -1 if unknown"
        
      - name: pd_cannulation_status
        type: string
        prompt_instruction: "pancreatic duct cannulation status, e.g. 'not attempted', 'successful', 'unsuccessful'"
      
      - name: cannulation_success
        type: boolean
        prompt_instruction: "if intent was biliary cannulation and bile duct cannulated; true/false"
        
      - name: lactated_ringers
        type: boolean
        prompt_instruction: "true/false"
        
      - name: rectal_indomethacin
        type: boolean
        prompt_instruction: "true/false"
        
      - name: successful_completion
        type: boolean
        prompt_instruction: "true/false"
        
      - name: failed_ercp
        type: boolean
        prompt_instruction: "true if it was, otherwise false"

  ## FINDINGS ##
  scout_film:
  # A scout film of the abdomen was performed. If normal: It appeared normal. Optional findings include: surgical clips in the xxx quadrant, pneumobilia, a biliary stent in situ, surgical drain, or residual contrast from prior study. If not obtained: A scout film was not obtained 
    description: "Abdominal scout film findings"
    report_section: "findings"
    report_subsection: "scout_film"
    template: |
      {% set _sf %}
      {% set status = scout_film_status | default('') | sku %}
      {% if status == 'not_obtained' %}
      A scout film was not obtained.
      {% else %}
      A scout film of the abdomen was performed{% if status == 'normal' %} and appeared normal{% endif %}.
      {% if scout_film_optional_findings | sku %}{{ scout_film_optional_findings | sent }}{% endif %}
      {% if scout_film_free_text | sku %} {{ scout_film_free_text | sent }}{% endif %}
      {% endif %}
      {% endset %}
      {{ _sf | replace('\n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim }}
    fields:
      - name: scout_film_status
        type: enum
        enum_values: ["normal", "abnormal", "not_obtained", "unknown", "none"]
        prompt_instruction: "'normal', 'abnormal', or 'not_obtained'"

      - name: scout_film_optional_findings
        type: string
        prompt_instruction: "If scout_film_status was abnormal, describe findings in sentence(s) if mentioned"

      - name: scout_film_free_text
        type: string
        prompt_instruction: "Any additional free-text description of scout film as complete sentence(s), else 'none"

  scope_advancement:
    #The duodenoscope (choose model: TJF-Q180V / TJF-Q190V / ED-530XT / other) was advanced to the second portion of the duodenum with / without difficulty and with / without detailed examination of the upper GI tract.  
    description: "Scope advancement and difficulty"
    report_section: "findings"
    report_subsection: "scope_advancement"
    template: |
      {% set difficulty = scope_advancement_difficulty | default('') | sku %}
      {% set gi_findings = upper_gi_findings | default('') | sku %}
      {% set exam_type = upper_gi_examination | default('limited') %}
      
      {% set _sa %}
      The duodenoscope {% if duodenoscope_type | sku %}{{ duodenoscope_type }} {% endif %}was advanced to the second portion of the duodenum 
      {% if difficulty == 'difficult' %}with difficulty{% else %}without difficulty{% endif %} and 
      {% if exam_type == 'detailed' %}with detailed{% else %}without detailed{% endif %} examination of the upper GI tract.
      {% if gi_findings == 'normal' or not gi_findings %}The esophagus, stomach, and duodenum appeared unremarkable on limited inspection.{% else %} {{ gi_findings | capfirst }} were seen.{% endif %}
      {% if difficulty == 'difficult' %} Scope advancement was challenging due to {{ scope_advancement_difficulty_reason | sku }} {% endif %}
      {% endset %}
      {{ _sa | replace('\n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim }}
    fields:
      - name: scope_advance_difficulty
        type: enum
        enum_values: ["with_difficulty", "without_difficulty", "unknown", "none"]
        prompt_instruction: "Record scope advancement as 'with_difficulty', 'without_difficulty', or 'unknown'"

      - name: upper_gi_examination_extent
        type: string
        prompt_instruction: "Extent of upper GI exam, e.g. 'without detailed examination', 'with limited examination', 'with detailed examination'"

      - name: upper_gi_findings
        type: string
        prompt_instruction: "If upper GI views described, summarize (e.g. 'normal', 'periampullary diverticulum', 'duodenal edema', 'ulcer'); else 'not described'"

  major_papilla:
    # The major papilla was identified. 
    # •	If normal: It appeared normal in position and morphology, with an intact orifice and no surrounding erythema or edema. 
    # •	If abnormal: The papilla appeared edematous / erythematous / scarred.
    # •	If not visualized: The papilla could not be located, and the procedure was aborted. 

    # •	If previous stent is removed : After removal of the previously placed stent evidence of prior sphincterotomy present. Orifice was patent / partially patent / narrowed/stenosed.
    # •	Optional findings include : A previously placed plastic or metal stent was seen emerging from the major papilla. Periampullary diverticulum present/absent. Papilla located inside the diverticulum / on the rim of the diverticulum / directly adjacent to the diverticulum / away from the diverticulum 
    description: "Major papilla identification and characteristics"
    report_section: "findings"
    report_subsection: "major_papilla"
    template: |
      {% set _major_pap %}
      {% set status = major_papilla_status | default('') | sku %}
      {% if status == 'not visualized' %}
      The major papilla could not be located, and the procedure was aborted.
      {% else %}
      The major papilla was identified. 
        {% if status == 'normal' %}It appeared normal in position and morphology, with an intact orifice and no surrounding erythema or edema.
        {% elif status == 'abnormal' and major_papilla_abnormal_morphology | sku and major_papilla_abnormal_morphology != 'none' %}The papilla appeared {{ major_papilla_abnormal_morphology }}.
        {% endif %}
      {% if prior_biliary_sphincterotomy_evidence %}
      After removal of the previously placed stent, evidence of prior sphincterotomy was present. 
        {% if prior_biliary_sphincterotomy_orifice_patency | sku %}Orifice was {{ prior_biliary_sphincterotomy_orifice_patency }}.{% endif %}
      {% endif %}
      {% if papilla_stent_present %}A previously placed plastic or metal stent was seen emerging from the major papilla.{% endif %}

      {% if periampullary_diverticulum_present %}Periampullary diverticulum present.
        {% if papilla_diverticulum_loc | sku %}Papilla located {{papilla_diverticulum_loc }}.{% endif %}
      {% endif %}
      {% if major_papilla_free_text | sku and major_papilla_free_text != 'none' %} {{ major_papilla_free_text | sent }}{% endif %}
      {% endif %}
      {% endset %}
      {{ _major_pap | replace('\n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim }}
    fields:
      - name: major_papilla_status
        type: enum
        enum_values: ["normal", "abnormal", "not visualized", "unknown"]
        prompt_instruction: "'normal', 'abnormal', or 'not visualized'"

      - name: major_papilla_abnormal_morphology
        type: string
        prompt_instruction: "If abnormal, describe appearance as 'edematous', 'erythematous', 'scarred'. Otherwise record 'none'"

      - name: prior_biliary_sphincterotomy_evidence
        type: boolean
        prompt_instruction: "true if evidence of prior biliary sphincterotomy is seen; false otherwise"

      - name: prior_biliary_sphincterotomy_orifice_patency
        type: string
        prompt_instruction: "If prior sphincterotomy present, describe orifice patency, e.g. patent, particially patent, narrowed stenosed, etc"

      - name: papilla_stent_present
        type: boolean
        prompt_instruction: "true if a plastic or metal stent is seen emerging from the major papilla; false otherwise"

      - name: periampullary_diverticulum_present
        type: boolean
        prompt_instruction: "true if periampullary diverticulum is present; false otherwise"

      - name: papilla_diverticulum_loc
        type: string
        prompt_instruction: "If present, describe location of papilla to diverticulum, eg. 'on the rim of the diverticulum'"

      - name: major_papilla_free_text
        type: string
        prompt_instruction: "Any additional free-text findings related to the major papilla as complete sentence(s)"

  minor_papilla:
    # The minor papilla was identified and inspected. 
    # •	If normal: It appeared normal in position and morphology, with an intact orifice and no surrounding erythema or edema. 
    # •	If abnormal: The papilla appeared edematous / erythematous / scarred.
    # •	If not visualized: The papilla could not be located. If not inspected: not inspected.
    # •	If previous stent is removed : After removal of the previously placed stent evidence of prior sphincterotomy present. Orifice was patent / partially patent / narrowed/stenosed.
    # •	Optional findings include : A previously placed plastic or metal stent was seen emerging from the major papilla. Periampullary diverticulum present/absent. Papilla located inside the diverticulum / on the rim of the diverticulum / directly adjacent to the diverticulum / away from the diverticulum 
    description: "Minor papilla identification and characteristics"
    report_section: "findings"
    report_subsection: "minor_papilla"
    template: |
      {% set _minor_pap %}
      {% set status = minor_papilla_status | default('') | sku %}
      {% if status == 'not_inspected' %}
      The minor papilla was not inspected.
      {% elif status == 'not_visualized' %}
      The minor papilla could not be located.

      {% elif status in ['normal', 'abnormal'] %}
      The minor papilla was identified and inspected. {% if status == 'normal' %}It appeared normal in position and morphology, with an intact orifice and no surrounding erythema or edema.{% elif minor_papilla_morphology | sku %}The papilla appeared {{ minor_papilla_morphology }}.{% endif %}
        {% if minor_papilla_prior_sphincterotomy %}After removal of the previously placed stent, evidence of prior sphincterotomy was present. 
          {% if minor_papilla_orifice_patency | sku and minor_papilla_orifice_patency not in ['none', 'unknown'] %}Orifice was {{ minor_papilla_orifice_patency | replace('_', ' ') }}.{% endif %}
        {% endif %}
        {% if minor_papilla_free_text | sku and minor_papilla_free_text != 'none' %} {{ minor_papilla_free_text | sent }}.{% endif %}
        {% endif %}
      {% endset %}
      {{ _minor_pap | replace('\n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim }}
    fields:
      - name: minor_papilla_status
        type: enum
        enum_values: ["normal", "abnormal", "none", "unknown"]
        prompt_instruction: "'normal', 'abnormal', 'not_visualized' if couldn't be located,  'not_inspected' if not inspected"

      - name: minor_papilla_morphology
        type: string
        prompt_instruction: "If described, summarize position, morphology, and mucosal changes e.g. 'normal', 'edematous', 'erythematous', 'scarred'"

      - name: minor_papilla_prior_sphincterotomy
        type: boolean
        prompt_instruction: "true if evidence of prior minor papillotomy/sphincterotomy; false otherwise"

      - name: minor_papilla_orifice_patency
        type: enum
        enum_values: ["patent", "partially_patent", "narrowed", "stenosed", "none", "unknown"]
        prompt_instruction: "If prior minor sphincterotomy present, describe orifice patency as 'patent', 'partially_patent', 'narrowed', or 'stenosed'"

      - name: minor_papilla_free_text
        type: string
        prompt_instruction: "Any additional free-text findings related to the minor papilla as complete sentence(s); else 'none'"

  ampulla:
  # The ampulla was identified and found to be Normal / Prominent / Patulous / Tumor infiltration / Prior sphincterotomy evident / Edematous / Bleeding / Pus draining / Bile draining / Periampullary diverticulum / Intradiverticular location / evidence of prior ampullectomy / papillectomy / Other : Free text option
    description: "Ampulla and periampullary region"
    report_section: "findings"
    report_subsection: "ampulla"
    template: |
      {% if ampulla_overall_appearance | sku %}
      The ampulla was identified and found to be {{ ampulla_overall_appearance }}.{% if ampulla_pus_present %} Pus was seen draining.{% endif %}
      {% if ampulla_active_bleeding %} Active bleeding was observed.{% endif %}
      {% if ampulla_free_text | sku and ampulla_free_text != 'none' %} {{ ampulla_free_text | capfirst }}.{% endif %}{% endif %}
    fields:
      - name: ampulla_overall_appearance
        type: string
        prompt_instruction: "Describe ampulla: 'normal', 'prominent', 'patulous', 'tumor infiltration', 'prior sphincterotomy evident', 'edematous', 'bleeding', 'pus draining', 'bile draining', 'periampullary diverticulum', 'intradiverticular location', 'evidence of prior ampullectomy/papillectomy', or combinations thereof"

      - name: ampulla_pus_present
        type: boolean
        prompt_instruction: "true if pus is seen draining; false otherwise"

      - name: ampulla_active_bleeding
        type: boolean
        prompt_instruction: "true if active bleeding is described at ampulla; false otherwise"

      - name: ampulla_free_text
        type: string
        prompt_instruction: "Any additional ampullary or periampullary details or features as complete sentence(s)"

  ampullectomy:
  # If ampullectomy was done: 
  # -	After a submucosal lift xx mm snare was used to perform ampullectomy.
  # -	 Resection was performed en bloc / piecemeal using electrocautery ERBE Endocut. The specimen was retrieved Roth net / snare retrieval / forceps / suction trap and sent for histopathology. The resection base and margins were carefully inspected; no / mild / active bleeding or perforation was seen. If bleeding hemostasis was achieved with dilute epinephrine injection / soft-coagulation / APC / hemoclip(s) / Other : Free text option
    description: "Details if an ampullectomy/papillectomy was performed"
    report_section: "findings"
    report_subsection: "ampullectomy"
    template: |
      {% if ampullectomy_performed %}
      After a submucosal lift{% if snare_size_mm > 0 %}, a {{ snare_size_mm }} mm snare{% else %}, a snare{% endif %} was used to perform ampullectomy. Resection was performed {% if resection_style | sku and resection_style not in ['none', 'unknown'] %}{{ resection_style | replace('_', ' ') }}{% endif %}{% if energy_settings | sku and energy_settings != 'not specified' %} using electrocautery {{ energy_settings }}{% endif %}. The specimen was retrieved {% if specimen_retrieval_method | sku and specimen_retrieval_method != 'not specified' %}{{ specimen_retrieval_method }}{% endif %} and sent for histopathology. The resection base and margins were carefully inspected; {% if resection_base_assessment | sku %}{{ resection_base_assessment }}{% endif %}.{% if ampullectomy_hemostasis_method | sku and ampullectomy_hemostasis_method != 'none' %} Hemostasis was achieved with {{ ampullectomy_hemostasis_method }}.{% endif %}
      {% endif %}
    fields:
      - name: ampullectomy_performed
        type: boolean
        prompt_instruction: "true if ampullectomy/papillectomy was performed; false otherwise"

      - name: snare_size_mm
        type: integer
        prompt_instruction: "Size of snare in mm if reported; -1 if not mentioned or NA"

      - name: resection_style
        type: enum
        enum_values: ["en bloc", "en_block", "en-bloc", "piecemeal", "none", "unknown"]
        prompt_instruction: "Whether resection was performed 'en bloc' or 'piecemeal'"

      - name: energy_settings
        type: string
        prompt_instruction: "Energy device and settings, e.g. 'ERBE Endocut'; 'not specified' if not mentioned"

      - name: specimen_retrieval_method
        type: string
        prompt_instruction: "Method used to retrieve specimen (Roth net, snare, forceps, suction trap); 'not specified' if not mentioned"

      - name: resection_base_assessment
        type: string
        prompt_instruction: "Description of resection base and margins (e.g. 'no bleeding', 'mild oozing', 'active bleeding', 'no perforation')"

      - name: ampullectomy_hemostasis_method
        type: string
        prompt_instruction: "If bleeding occurred, how it was controlled (e.g. dilute epinephrine, soft coagulation, APC, hemoclips); 'none' if no hemostasis required"

  bile_duct_cannulation:
    # Bile duct cannulation was attempted using a sphincterotome (CleverCut3V / Autotome RX / Dreamtome / Hydratome / Fusion OMNI / other) preloaded with a guidewire. (HydraJag 0.035" or 0.025" / VisiGlide 2 / Dreamwire / Jagwire / Tracer Metro / other). 
    # Bile duct cannulation was successful / unsuccessful. If Successful: Biliary cannulation was achieved without pancreatic duct entry. If abnormal: Multiple attempts were required with / without inadvertent pancreatic duct access. Optional findings: Cannulation achieved via double-wire technique, needle-knife precut, or through a prior sphincterotomy.
    # If not achieved: Cannulation was unsuccessful and the procedure was terminated /rendezvous planned. If Standard cannulation failed: Precut sphincterotomy / Precut fistulotomy / Double wire technique / septotomy was performed / EUS guided rendezvous was performed and was successful / unsuccessful. 
    description: "Bile duct cannulation and techniques"
    report_section: "findings"
    report_subsection: "bile_duct_cannulation"
    template: |
      {% set _bile %}
      {% if sphincterotome_type | sku or guidewire_type | sku %}
      Bile duct cannulation was attempted using a sphincterotome{% if sphincterotome_type | sku %} ({{ sphincterotome_type }}){% endif %} preloaded with a guidewire{% if guidewire_type | sku %} ({{ guidewire_type }}){% endif %}.{% endif %}
      {% if bile_duct_cannulation_successful %}
      Bile duct cannulation was successful. {% if bile_duct_cannulation_difficulty | sku %}{{ bile_duct_cannulation_difficulty | sent }}{% endif %}{% if advanced_cannulation_techniques | sku and advanced_cannulation_techniques != 'none' %} Cannulation achieved via {{ advanced_cannulation_techniques }}.{% endif %}
      {% else %}Bile duct cannulation was unsuccessful.
        {% if bile_duct_cannulation_difficulty | sku %} {{ bile_duct_cannulation_difficulty | sent }}{% endif %}
        {% if advanced_cannulation_techniques | sku and advanced_cannulation_techniques != 'none' %} {{ advanced_cannulation_techniques | capfirst }} was performed {% endif %}
        {% if rendezvous_attempted %}{% if rendezvous_result | sku %} EUS-guided rendezvous was performed and was {{ rendezvous_result }}.{% else %} Rendezvous was planned.{% endif %}
        {% else %} The procedure was terminated.{% endif %}{% endif %}
      {% endset %}
      {{ _bile | replace('\n', ' ') | replace(' ', ' ') | trim }}
      
    fields:
      - name: sphincterotome_type
        type: string
        prompt_instruction: "Type of sphincterotome used (CleverCut3V, Autotome RX, Dreamtome, Hydratome, Fusion OMNI, other)"

      - name: guidewire_type
        type: string
        prompt_instruction: "Guidewire used: 'HydraJag 0.035', 'HydraJag 0.025', 'VisiGlide 2', 'Dreamwire', 'Jagwire', 'Tracer Metro', or 'other'"

      - name: bile_duct_cannulation_successful
        type: boolean
        prompt_instruction: "true/false if successful"

      - name: bile_duct_cannulation_difficulty
        type: string
        prompt_instruction: "Describe in a sentence if multiple attempts required and whether inadvertent PD access occurred, e.g. 'Multiple attempts were required without inadvertent pancreatic duct access'"

      - name: advanced_cannulation_techniques
        type: string
        prompt_instruction: "If used, describe techniques such as 'double-wire', 'needle-knife precut', 'precut fistulotomy', 'septotomy', or 'through prior sphincterotomy'; else 'none'"

      - name: rendezvous_attempted
        type: boolean
        prompt_instruction: "true/false, if EUS-guided or percutaneous rendezvous was attempted"

      - name: rendezvous_result
        type: string
        prompt_instruction: "If rendezvous attempted, indicate 'successful', 'unsuccessful', and route (transgastric/transduodenal)"

  pancreatic_duct_cannulation:
    # Pancreatic duct cannulation was attempted / not attempted but inadvertently cannulated. If intentional and successful: Pancreatic duct was selectively cannulated with precut sphincterotomy / EUS guided rendezvous.  If biliary rendezvous performed: Transgastric / transduodenal puncture was performed successfully / unsuccessfully. 
    description: "Pancreatic duct cannulation details"
    report_section: "findings"
    report_subsection: "pancreatic_duct_cannulation"
    template: |
      {% set attempt = pancreatic_duct_cannulation_attempted | default('') | sku %}
      {% if attempt == 'intentional' %}
      Pancreatic duct cannulation was attempted.{% if pancreatic_duct_cannulation_success %} Pancreatic duct was selectively cannulated{% if pancreatic_duct_cannulation_technique | sku %} with {{ pancreatic_duct_cannulation_technique }}{% endif %}.{% else %} Cannulation was unsuccessful.{% endif %}
      {% elif attempt == 'not_attempted_inadvertent' %}
      Pancreatic duct cannulation was not attempted but was inadvertently cannulated.
      {% endif %}
      {% if biliary_rendezvous_route | sku and biliary_rendezvous_route != 'not applicable' %} {{ biliary_rendezvous_route | capfirst }} puncture was performed.{% endif %}
    fields:
      - name: pancreatic_duct_cannulation_attempted
        type: enum
        enum_values: ["intentional", "not_attempted_inadvertent", "not_attempted_no_entry", "uknown", "none"]
        prompt_instruction: "'intentional' if PD cannulation was planned, 'not_attempted_inadvertent' if only inadvertent entry, or 'not_attempted_no_entry'"

      - name: pancreatic_duct_cannulation_success
        type: boolean
        prompt_instruction: "true/false, if selective pancreatic duct access was achieved"

      - name: pancreatic_duct_cannulation_technique
        type: string
        prompt_instruction: "If intentional and successful, describe technique (e.g. 'standard wire-guided', 'after precut', 'EUS-guided rendezvous')"

      - name: biliary_rendezvous_route
        type: string
        prompt_instruction: "If EUS-guided biliary rendezvous performed, specify 'transgastric' or 'transduodenal' and success; else 'not applicable'"

  cholangiogram:
  # Contrast was injected under fluoroscopic guidance and cholangiogram was performed. If not performed : Contrast injection was not performed. 
  # If normal: The common bile duct (CBD) measured [6–10 mm] and was normal. Intrahepatic ducts were normal in caliber, and contrast drained freely into the duodenum
  # If dilated: The CBD measured [11–16 mm]; intrahepatic ducts were [mildly / moderately / severely] dilated. 
  # If stones: Rounded filling defect(s) measuring [3–20 mm] were seen in the [distal / mid / proximal CBD / CHD / hilar region]. 
  # If stricture: A [distal / mid / hilar / anastomotic] stricture of [5–30 mm] length and [2–5 mm] diameter was identified; margins were [smooth, benign-appearing / irregular, malignant-appearing / indeterminate]. 
  # If Filling defects: Stones/sludge/debris/air bubbles located in the distal/mid,/proximal common bile duct/ common hepatic duct/hilar region. 
  # If bile leak: Contrast extravasation from the [cystic duct stump / duct / anastomosis] consistent with a bile leak. 
  # If prior stent in place: The previously placed stent opacified the CBD, confirming intraductal position; flow through the stent was [patent / sluggish / occluded].
  # Other: Free text
    description: "Cholangiogram findings"
    report_section: "findings"
    report_subsection: "cholangiogram"
    template: |
      {% if contrast_injection_performed %}
      Contrast was injected under fluoroscopic guidance and cholangiogram was performed.
      {% if cbd_diameter_mm > 0 %}The common bile duct (CBD) measured {{ cbd_diameter_mm }} mm{% if cbd_diameter_mm >= 6 and cbd_diameter_mm <= 10 %} and was normal{% endif %}.{% endif %}
      {% if ihd_status | sku and ihd_status not in ['unknown', 'none'] %} Intrahepatic ducts were {{ ihd_status | replace('_', ' ') }}{% if ihd_status == 'normal' %} in caliber, and contrast drained freely into the duodenum{% endif %}.{% endif %}
      {% if stone_description | sku and stone_description != 'none' %} {{ stone_description | sent }}{% endif %}
      {% if stricture_description | sku and stricture_description != 'none' %} {{ stricture_description | sent }}{% endif %}
      {% if non_stone_filling_defects | sku %} {{ non_stone_filling_defects | sent }}{% endif %}
      {% if bile_leak_location | sku and bile_leak_location != 'none' %} Contrast extravasation from the {{ bile_leak_location }} consistent with a bile leak.{% endif %}
      {% if prior_stent_status | sku and prior_stent_status != 'none' %} {{ prior_stent_status | sent }}{% endif %}
      {% if cholangiogram_free_text | sku and cholangiogram_free_text != 'none' %} {{ cholangiogram_free_text | sent }}{% endif %}
      {% endif %}
    fields:
      - name: contrast_injection_performed
        type: boolean
        prompt_instruction: "'true' if cholangiogram performed"

      - name: cbd_diameter_mm
        type: float
        prompt_instruction: "CBD diameter in mm if reported, -1 if not mentioned"

      - name: ihd_status
        type: enum
        enum_values: ["normal", "mildly dilated", "moderately dilated", "severely dilated", "unknown", "none"]
        prompt_instruction: "If the CBD diameter is 6-10 mm, record 'normal'. If larger, record 'mildly dilated', moderately dilated, or 'severely dilated'"

      - name: stone_description
        type: string
        prompt_instruction: "If stones present, describe size in mm and location as a sentence. Otherwise 'none'"

      - name: stricture_description
        type: string
        prompt_instruction: "If stricture, describe: location (distal/mid/hilar/anastomotic), length, diameter, margins (benign-appearing, malignant, indeterminate) as a sentence. Otherwise 'none'"

      - name: non_stone_filling_defects
        type: string
        prompt_instruction: "Describe any other filling defects such as sludge/debris/air bubbles and their locations as a sentence; otherwise 'none'"

      - name: bile_leak_location
        type: string
        prompt_instruction: "If bile leak: record location such as 'cystic duct stump', 'duct', 'anastomosis'. Otherwise 'none'"

      - name: prior_stent_status
        type: string
        prompt_instruction: "Describe prior stent if present (e.g. 'CBD opacified through prior stent, flow patent/sluggish/occluded'). Otherwise 'none'"

      - name: cholangiogram_free_text
        type: string
        prompt_instruction: "Any additional cholangiographic details not captured above as complete sentence(s); else 'none'"

  pancreatogram:
  # Pancreatogram was obtained and normal / stricture / dilation / stones/ filling defect / pancreatic duct leak / pancreas divisum identified. 
    # If not done : Pancreatogram not performed. 
    # -	Main PD diameter was xx cm at head/body/tail.
    # -	 Side branches were normal / dilated / irregular. 
    # -	Stricture was located at head / body / tail. 
    # -	There was / was no communication with pseudocyst. 

    description: "Pancreatogram findings"
    report_section: "findings"
    report_subsection: "pancreatogram"
    template: |
      {% if pancreatogram_obtained %}
      Pancreatogram was obtained{% if pancreatogram_overall | sku %} and {{ pancreatogram_overall }} identified{% endif %}.
      {% if main_pd_diameter_head_mm > 0 or main_pd_diameter_body_mm > 0 or main_pd_diameter_tail_mm > 0 %} Main PD diameter was{% if main_pd_diameter_head_mm > 0 %} {{ main_pd_diameter_head_mm }} mm at head{% endif %}{% if main_pd_diameter_body_mm > 0 %}{% if main_pd_diameter_head_mm > 0 %},{% endif %} {{ main_pd_diameter_body_mm }} mm at body{% endif %}{% if main_pd_diameter_tail_mm > 0 %}{% if main_pd_diameter_head_mm > 0 or main_pd_diameter_body_mm > 0 %},{% endif %} {{ main_pd_diameter_tail_mm }} mm at tail{% endif %}.{% endif %}
      {% if side_branch_status | sku and side_branch_status not in ['unknown', 'none'] %} Side branches were {{ side_branch_status }}.{% endif %}
      {% if pd_stricture_location | sku and pd_stricture_location != 'none' %} Stricture was located at {{ pd_stricture_location }}.{% endif %}
      {% if pd_pseudocyst_communication is defined %} There was {% if not pd_pseudocyst_communication %}no {% endif %}communication with pseudocyst.{% endif %}
      {% endif %}
    fields:
      - name: pancreatogram_obtained
        type: boolean
        prompt_instruction: "true if pancreatogram was obtained; false if not"

      - name: pancreatogram_overall
        type: string
        prompt_instruction: "Summarize pancreatogram as: 'normal', 'stricture', 'dilation', 'stones', 'filling defect', 'PD leak', 'pancreas divisum', etc."

      - name: main_pd_diameter_head_mm
        type: float
        prompt_instruction: "Main PD diameter at head in mm if given; -1 if not"

      - name: main_pd_diameter_body_mm
        type: float
        prompt_instruction: "Main PD diameter at body in mm if given; -1 if not"

      - name: main_pd_diameter_tail_mm
        type: float
        prompt_instruction: "Main PD diameter at tail in mm if given; -1 if not"

      - name: side_branch_status
        type: enum
        enum_values: ["normal", "dilated", "irregular", "unknown", "none"]
        prompt_instruction: "Side branch appearance as 'normal', dilated', 'irregular' if described"

      - name: pd_stricture_location
        type: string
        prompt_instruction: "If PD stricture present, location (head/body/tail); else 'none'"

      - name: pd_pseudocyst_communication
        type: boolean
        prompt_instruction: "'true' if communication with pseudocyst was described, else 'false'"

  sphincterotomy:
  #   performed using a CleverCut3V / Autotome RX / Dreamtome / Hydratome / Fusion OMNI / needle-knife / septotomy / Other sphincterotome. The incision was directed toward the 11–12 / 12–1 o’clock position and extended to a small / moderate / large papillotomy until adequate bile flow / pancreatic juice / guidewire passage / stone extraction was achieved.     
    description: "Biliary and/or pancreatic sphincterotomy details"
    report_section: "findings"
    report_subsection: "sphincterotomy"
    template: |
      {% if sphincterotomy_type | sku and sphincterotomy_type != 'none' %}
      {% set ns = namespace(parts=[]) %}
      {# base sentence: mention sphincterotomy and optional instrument #}
      {% set base = 'Sphincterotomy was performed' %}
      {% if sphincterotome_used | sku %}
        {% set base = base ~ ' using a ' ~ (sphincterotome_used) %}
      {% endif %}
      {% set base = base ~ '.' %}
      {% set ns.parts = ns.parts + [base] %}

      {# optional incision details: direction, extent, and goal #}
      {% if incision_direction | sku %}
        {% set clause = 'The incision was directed toward the ' ~ incision_direction ~ ' position' %}
        {% if sphincterotomy_extent | sku and sphincterotomy_extent != 'none' %}
          {% set clause = clause ~ ' and extended to a ' ~ sphincterotomy_extent ~ ' papillotomy' %}
          {% if sphincterotomy_goal_achieved | sku %}
            {% set clause = clause ~ ' until ' ~ sphincterotomy_goal_achieved ~ ' was achieved' %}
          {% endif %}
        {% endif %}
        {% set clause = clause ~ '.' %}
        {% set ns.parts = ns.parts + [clause] %}
      {% endif %}

      {{ ns.parts | join(' ') }}
      {% endif %}
    fields:
      - name: sphincterotomy_type
        type: enum
        enum_values: ["biliary", "pancreatic", "both", "none"]
        prompt_instruction: "Type of sphincterotomy. Record 'biliary', 'pancreatic', 'both', or 'none'"

      - name: sphincterotome_used
        type: string
        prompt_instruction: "Device used: 'CleverCut3V', 'Autotome RX', 'Dreamtome', 'Hydratome', 'Fusion OMNI', 'needle-knife', 'septotomy', etc."

      - name: incision_direction
        type: string
        prompt_instruction: "Clock-face direction, e.g. '11-12 o'clock', '12-1 o'clock'"

      - name: sphincterotomy_extent
        type: enum
        enum_values: ["small", "moderate", "large", "none", "unknown"]
        prompt_instruction: "Extent of papillotomy as 'small', 'moderate', 'large'"

      - name: sphincterotomy_goal_achieved
        type: string
        prompt_instruction: "Goal of sphincterotomy as 'adequate bile flow', 'pancreatic juice', 'guidewire passage', 'stone extraction' was achieved"

  biliary_stents:
    # If Plastic biliary: straight / single-pigtail / double-pigtail stent with a single flap / double flap / barbed / none of 5F / 7F / 10F by Length: 5 / 7 / 9 / 10 / 12 / 15 cm was used. 
    # If metal biliary: fully covered (FCSEMS) / partially covered / uncovered metal stent of diameter 8 / 10 / 12 mm by length 40 / 60 / 80 / 100 / 120 mm was used with flared ends / anti-migration fins / retrieval lasso / tapered tip. Deployed suprapapillary / transpapillary / intraductal above papilla across distal CBD stricture / mid CBD / hilar / anastomotic stricture / bile leak site. Distal end was 2–3 mm beyond papilla / flush with papilla / 5–10 mm into duodenum and proximal end was xx cm into CBD / CHD / right/left hepatic duct / above/below cystic duct take-off.
    description: "Biliary stent details if placed"
    report_section: "findings"
    report_subsection: "biliary_stent"
    #* 'building sentences' approach... maybe better for readability of jinja than a single long template but idk??
    template: |
      {% if biliary_stent_type == 'plastic' %}
        {% set sentence = 'A ' %}
        {% if plastic_biliary_type | sku %}
          {% set sentence = sentence ~ plastic_biliary_type ~ ' ' %}
        {% endif %}
        {% set sentence = sentence ~ 'plastic biliary stent' %}
        {% if plastic_biliary_size | sku %}
          {% set sentence = sentence ~ ' of ' ~ plastic_biliary_size %}
        {% endif %}
        {% if plastic_biliary_length is defined and plastic_biliary_length > 0 %}
          {% set sentence = sentence ~ ' by ' ~ plastic_biliary_length ~ ' cm' %}
        {% endif %}
        {% set sentence = sentence ~ ' was placed.' %}
      {% set ns.parts = ns.parts + [sentence] %}
      {% endif %}

      {% if biliary_stent_type == 'metal' %}
      A {{ metal_biliary_type }} metal biliary stent
      {% if metal_biliary_length > 0 %} of length {{ metal_biliary_length }} mm{% endif %}
      was placed.
      {% if metal_biliary_narrative | sku %}
      {{ metal_biliary_narrative }}
      {% endif %}
      {% endif %}
    fields:
      - name: biliary_stent_type
        type: enum
        enum_values: ["plastic", "metal", "none", "unknown"]
        prompt_instruction: "If biliary stent placed, record type as 'plastic'/'metal'"

      - name: plastic_biliary_size
        type: string
        prompt_instruction: "If plastic stent placed, record diameter, 5F/7F/10F"

      - name: plastic_biliary_type
        type: string
        prompt_instruction: "If plastic stent placed, record type, single flap/double flap/barbed" 
        
      - name: plastic_biliary_length
        type: integer
        prompt_instruction: "If plastic stent placed, record length in cm, e.g. 5/7/9/10/12/15"

      - name: metal_biliary_type
        type: string
        prompt_instruction: "If metal stent placed, record coverage as 'FCSEMS' (if fully covered)/ 'PCSEMS' (if partially covered) / 'UCSEMS' (if uncovered)"

      - name: metal_biliary_type_features
        type: string
        prompt_instruction: "If metal stent placed, record features such as flared ends/anti-migration fins/retrieval lasso/tapered tip"
#! check results of this prompt
      - name: metal_biliary_narrative
        type: string
        prompt_instruction: "If metal stent placed, describe its deployment in sentences in the following format, choosing the right findings for fields in square brackets []: 'Deployed [suprapapillary/transpapillary/intraductal above papilla across the [distal CBD stricture/mid CBD/hilar/anastomotic stricture/bile leak site]. Distal end was [2-3 mm beyond papilla/flush with papilla/5-10 mm into duodenum] and proximal end was [xx cm] into [CBD/CHD/right hepatic duct/left hepatic duct/above cystic duct take-off/below cystic duct take-off].'"

      - name: metal_biliary_length
        type: integer
        prompt_instruction: "If metal stent placed, record length in mm, e.g. 40/60/80/100/120"

  pancreatic_stents:
    # If for prophylaxis 3F straight, no internal flap / 5F straight, no internal flap was used. 
      # If for therapeutic 5F / 7F straight / single-pigtail / double-pigtail with single / double internal flaps was used.  Length was 3 / 5 / 7 / 9 / 12 cm with tip positioned in head / body / tail approximately xx cm from the orifice.
    # Final position was optimal / suboptimal 
      # 1.	If optimal: distal end at duodenal lumen / just beyond papilla. 
      # 2.	If suboptimal: the stent was too proximal / too distal / kinked / not bridging the lesion / partially intramural. Adjustment was performed using rat-tooth forceps / snare reposition / balloon push–pull / partial redeployment / complete exchange. 
    description: "Pancreatic stent details if placed"
    report_section: "findings"
    report_subsection: "pancreatic_stent"
    template: |
      {% if pd_stent_placed %}
      {% set ns = namespace(parts=[]) %}

      {% if pd_stent_purpose == 'pep_prophylaxis' %}
      {% set base = 'A ' ~ pd_stent_size ~ ' ' ~ pd_stent_type ~ ' stent was placed for PEP prophylaxis.' %}
      {% elif pd_stent_purpose == 'therapeutic' %}
        {% set base = 'A ' ~ pd_stent_size ~ ' ' ~ pd_stent_type ~ ' stent was placed for therapeutic purposes.' %}
      {% else %}
        {% set base = 'Pancreatic duct stent was placed.' %}
      {% endif %}
      {% set ns.parts = ns.parts + [base] %}

      {% if pd_stent_purpose == 'therapeutic' and pd_stent_therapy_flaps | sku and pd_stent_therapy_narrative | sku %}
        {% set therapy_clause = 'The stent had ' ~ pd_stent_therapy_flaps ~ ' internal flap(s). ' ~ pd_stent_therapy_narrative %}
        {% set ns.parts = ns.parts + [therapy_clause] %}
      {% endif %}

      {% if pd_placement_narrative | sku %}
        {% set ns.parts = ns.parts + [pd_placement_narrative] %}
      {% endif %}

      {{ ns.parts | join(' ') }}
      {% endif %}
    fields:
      - name: pd_stent_placed
        type: boolean
        prompt_instruction: "true if pancreatic duct stent was placed; false otherwise"

      - name: pd_stent_purpose
        type: enum
        enum_values: ["pep_prophylaxis", "therapeutic", "none", "unknown"]
        prompt_instruction: "Purpose of pancreatic stent: 'pep_prophylaxis', 'therapeutic'"

      - name: pd_stent_size
        type: string
        prompt_instruction: "If pd stent placed, record diameter, 3F/5F"

      - name: pd_stent_type
        type: string
        prompt_instruction: "If pd stent placed, record type, straight/single-pigtail/double-pigtail"
        If therapeutic: size (5F/7F), configuration (straight/single-pigtail/double-pigtail), flaps (single/double), length (3/5/7/9/12 cm), and tip position (head/body/tail, distance from orifice).

      - name: pd_stent_therapy_flaps
        type: string
        prompt_instruction: "If therapeutic pd stent placed, record number of internal flaps: 'single', 'double'"

      - name: pd_stent_therapy_narrative
        type: string
        prompt_instruction: "If therapeutic pd stent placed, describe length and positioning as sentence: 'Length was [xx] cm with tip positioned in [head/body/tail] approximately [xx cm] from the orifice.'"
        
      - name: pd_placement_narrative
        type: string
        prompt_instruction: "Describe final pd stent placement in sentences with the following format: 'Final position was [optimal/suboptimal].' If optimal: 'Distal end [at duodenal lumen/just beyond papilla].' If suboptimal: 'The stent was [too proximal/too distal/kinked/not bridging the lesion/partially intramural]. Adjustment was performed using [technique]'"

  post_procedure_static:
    description: ""
    report_section: "findings"
    report_subsection: "post_procedure_static"
    template: |
      The scope was then completely withdrawn from the patient and the procedure completed.
    fields: []
    
  blood_loss:
    # "XX ml blood loss"
    description: "Estimated blood loss"
    report_section: "findings"
    report_subsection: "blood_loss"
    template: |
      {% if estimated_blood_loss > 0 %}
      Estimated blood loss: {{ estimated_blood_loss }} ml.
      {% elif estimated_blood_loss == 0 %}
      Estimated blood loss: None.
      {% endif %}
    fields:
      - name: estimated_blood_loss
        type: float
        prompt_instruction: "Estimated blood loss in ml, as a integer. -1 if not mentioned"

  specimens_removed:
    description: "Specimens removed"
    report_section: "findings"
    report_subsection: "specimens"
    template: |
      {% if specimens_removed | sku and specimens_removed != 'none' %}
      Specimens removed: Specimens were optained. {{ specimens_removed | sent }}
      {% elif specimens_removed == 'none' %}
      Specimens removed: None.
      {% endif %}
    fields:
      - name: specimens_removed
        type: string
        prompt_instruction: "If speciments were obtained, describe their details/findings"
        
  complications:
    description: "Complications from procedure"
    report_section: "findings"
    report_subsection: "complications"
    template: |
      {% if complications | sku and complications != 'none' %}
      Complications: {{ complications | sent }}
      {% elif complications == 'none' %}
      Complications: There were no immediate complications.
      {% endif %}
    fields:
      - name: complications
        type: string
        prompt_instruction: "If there were complications from procedure, describe details/findings as sentence(s)"
  
## IMPRESSIONS
  impressions:
    description: "Impressions summarizing key findings"
    report_section: "impressions"
    # todo in drafter, capialize and make into numbered list
    template: |
      {{ impressions }}
    fields:
      - name: impressions
        type: list
        prompt_instruction: |
          Summarize the most important findings, procedures, and biopsies as a comma-separated list of strings.
          If there are multiple normal findings, combine them into a single list item for EGD and another for ERCP (for example: "Normal ERCP examination of x, y, z" where x, y, z are different areas with normal ERCP findings). Normal findings do not need to be in the order of examination.
          Do not include scout film results.
## RECS
  recommendations:
    report_section: "recommendations"
    template: |
      {{ recommendations }}
    fields:
      - name: recommendations
        type: list
        prompt_instruction: "If the clinician describes specific recommendations for follow-up in the procedure transcript, record the recommendation(s) as a comma-separated list of strings. Otherwise leave blank."