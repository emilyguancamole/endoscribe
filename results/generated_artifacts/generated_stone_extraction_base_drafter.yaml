meta:
  procedure_group: ercp
  procedure_type: stone_extraction_base
  title: ERCP Stone Extraction
  version: 1.0.1
  extraction_group: base
  module_id: '0.2'
  insert_after: cholangiogram
  active_modules:
  - base
  - '0.2'
  extraction_group_map:
    indications: base
    patient_history: base
    medications: base
    monitoring: base
    procedure_description: base
    quality_metrics: base
    scout_film: base
    scope_advancement: base
    major_papilla: base
    minor_papilla: base
    ampulla: base
    ampullectomy: base
    bile_duct_cannulation: base
    pancreatic_duct_cannulation: base
    cholangiogram: base
    pancreatogram: base
    sphincterotomy: base
    biliary_stents: base
    pancreatic_stents: base
    post_procedure_static: base
    blood_loss: base
    specimens_removed: base
    complications: base
    impressions: base
    recommendations: base
    initial_extraction: stone_management
    chol_lithotripsy: stone_management
    eplbd: stone_management
    mechanical_lithotripsy: stone_management
    stone_therapy_wrapup: stone_management
prompts:
  definition_file: prompts/ercp/generated_stone_extraction_base_prompt.txt
templates:
  indications: '{{ age }}-year-old {{ sex }} patient is here for an ERCP procedure
    {% if chief_complaints | sku %}for {{ chief_complaints | sku | lower }}{% endif
    %}.'
  history: 'The patient reports {{ symptoms_duration | sku }} history of {{ chief_complaints
    | lower | sku }}.

    {{ symptoms_narrative | sku | sent }}

    {% if negative_history | sku %}No history of {{ negative_history | sku }} is reported
    unless otherwise specified.{% endif %}

    {% if past_medical_history | sku %}{{ past_medical_history | sku | sent }}{% endif
    %} {% if current_medications | sku %} Current medications include {{ current_medications
    | sku }}.{% endif %}

    {% if family_history | sku %}{{ family_history | sku | sent }}{% endif %} {% if
    social_history | sku %}{{ social_history | sku | sent }}{% endif %}'
  medications: '{{ medications | default_if_unknown(''Refer to record of source.'')
    }}'
  monitoring: '{{ monitoring | default_if_unknown(''Johns Hopkins Standard.'') }}'
  description_of_procedure: '{% set scope_type = duodenoscope_type | default('''')
    | sku %}

    After the risks, benefits and alternatives of the procedure were thoroughly explained,
    informed consent was verified, confirmed and timeout was successfully executed
    by the treatment team. With the patient in the left semi-prone position, medications
    were administered intravenously. The duodenoscope {% if scope_type %}{{ scope_type
    }} {% endif %}was passed from the mouth into the esophagus and further advanced
    from the esophagus into the stomach. From the stomach, the scope was directed
    to the second portion of the duodenum.'
  ercp_quality_metrics: '{% if grade_of_ercp | sku %}

    Difficulty of ERCP: Grade {{ grade_of_ercp }}.

    {% endif %}

    {% if pd_cannulation_status | sku %}

    Pancreatic duct cannulation {{ pd_cannulation_status | sent }}

    {% endif %}

    {% if cannulation_success | sku %}Cannulation success: {% if cannulation_success
    %}Yes{% else %}No{% endif %}.

    {% endif %}

    {% if lactated_ringers | sku %}

    Post-ERCP pancreatitis prophylaxis: {% if lactated_ringers %}Lactated ringers:
    Yes, refer to record of source{% else %}No{% endif %}.

    {% endif %}

    {% if rectal_indomethacin | sku %}Rectal indomethacin: {% if rectal_indomethacin
    %} Yes{% else %}No{% endif %}.

    {% endif %}

    {% if successful_completion | sku %}Successful completion of intended procedure:
    {% if successful_completion %}Yes{% else %}No{% endif %}.

    {% endif %}

    {% if failed_ercp | sku %}

    Failed ERCP from another facility or provider: {% if failed_ercp %}Yes{% else
    %}No{% endif %}.{% endif %}'
  findings: "{% set _sf %}\n{% set status = scout_film_status | default('') | sku\
    \ %}\n{% if status == 'not_obtained' %}\nA scout film was not obtained.\n{% else\
    \ %}\nA scout film of the abdomen was performed{% if status == 'normal' %} and\
    \ appeared normal{% endif %}.\n{% if scout_film_optional_findings | sku %}{{ scout_film_optional_findings\
    \ | sent }}{% endif %}\n{% if scout_film_free_text | sku %} {{ scout_film_free_text\
    \ | sent }}{% endif %}\n{% endif %}\n{% endset %}\n{{ _sf | replace('\\n', ' ')\
    \ | replace('  ', ' ') | replace('  ', ' ') | trim }}\n\n{% set difficulty = scope_advancement_difficulty\
    \ | default('') | sku %}\n{% set gi_findings = upper_gi_findings | default('')\
    \ | sku %}\n{% set exam_type = upper_gi_examination | default('limited') %}\n\n\
    {% set _sa %}\nThe duodenoscope {% if duodenoscope_type | sku %}{{ duodenoscope_type\
    \ }} {% endif %}was advanced to the second portion of the duodenum \n{% if difficulty\
    \ == 'difficult' %}with difficulty{% else %}without difficulty{% endif %} and\
    \ \n{% if exam_type == 'detailed' %}with detailed{% else %}without detailed{%\
    \ endif %} examination of the upper GI tract.\n{% if gi_findings == 'normal' or\
    \ not gi_findings %}The esophagus, stomach, and duodenum appeared unremarkable\
    \ on limited inspection.{% else %} {{ gi_findings | capfirst }} were seen.{% endif\
    \ %}\n{% if difficulty == 'difficult' %} Scope advancement was challenging due\
    \ to {{ scope_advancement_difficulty_reason | sku }} {% endif %}\n{% endset %}\n\
    {{ _sa | replace('\\n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim\
    \ }}\n\n{% set _major_pap %}\n{% set status = major_papilla_status | default('')\
    \ | sku %}\n{% if status == 'not visualized' %}\nThe major papilla could not be\
    \ located, and the procedure was aborted.\n{% else %}\nThe major papilla was identified.\
    \ \n  {% if status == 'normal' %}It appeared normal in position and morphology,\
    \ with an intact orifice and no surrounding erythema or edema.\n  {% elif status\
    \ == 'abnormal' and major_papilla_abnormal_morphology | sku and major_papilla_abnormal_morphology\
    \ != 'none' %}The papilla appeared {{ major_papilla_abnormal_morphology }}.\n\
    \  {% endif %}\n{% if prior_biliary_sphincterotomy_evidence %}\nAfter removal\
    \ of the previously placed stent, evidence of prior sphincterotomy was present.\
    \ \n  {% if prior_biliary_sphincterotomy_orifice_patency | sku %}Orifice was {{\
    \ prior_biliary_sphincterotomy_orifice_patency }}.{% endif %}\n{% endif %}\n{%\
    \ if papilla_stent_present %}A previously placed plastic or metal stent was seen\
    \ emerging from the major papilla.{% endif %}\n\n{% if periampullary_diverticulum_present\
    \ %}Periampullary diverticulum present.\n  {% if papilla_diverticulum_loc | sku\
    \ %}Papilla located {{papilla_diverticulum_loc }}.{% endif %}\n{% endif %}\n{%\
    \ if major_papilla_free_text | sku and major_papilla_free_text != 'none' %} {{\
    \ major_papilla_free_text | sent }}{% endif %}\n{% endif %}\n{% endset %}\n{{\
    \ _major_pap | replace('\\n', ' ') | replace('  ', ' ') | replace('  ', ' ') |\
    \ trim }}\n\n{% set _minor_pap %}\n{% set status = minor_papilla_status | default('')\
    \ | sku %}\n{% if status == 'not_inspected' %}\nThe minor papilla was not inspected.\n\
    {% elif status == 'not_visualized' %}\nThe minor papilla could not be located.\n\
    \n{% elif status in ['normal', 'abnormal'] %}\nThe minor papilla was identified\
    \ and inspected. {% if status == 'normal' %}It appeared normal in position and\
    \ morphology, with an intact orifice and no surrounding erythema or edema.{% elif\
    \ minor_papilla_morphology | sku %}The papilla appeared {{ minor_papilla_morphology\
    \ }}.{% endif %}\n  {% if minor_papilla_prior_sphincterotomy %}After removal of\
    \ the previously placed stent, evidence of prior sphincterotomy was present. \n\
    \    {% if minor_papilla_orifice_patency | sku and minor_papilla_orifice_patency\
    \ not in ['none', 'unknown'] %}Orifice was {{ minor_papilla_orifice_patency |\
    \ replace('_', ' ') }}.{% endif %}\n  {% endif %}\n  {% if minor_papilla_free_text\
    \ | sku and minor_papilla_free_text != 'none' %} {{ minor_papilla_free_text |\
    \ sent }}.{% endif %}\n  {% endif %}\n{% endset %}\n{{ _minor_pap | replace('\\\
    n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim }}\n\n{% if ampulla_overall_appearance\
    \ | sku %}\nThe ampulla was identified and found to be {{ ampulla_overall_appearance\
    \ }}.{% if ampulla_pus_present %} Pus was seen draining.{% endif %}\n{% if ampulla_active_bleeding\
    \ %} Active bleeding was observed.{% endif %}\n{% if ampulla_free_text | sku and\
    \ ampulla_free_text != 'none' %} {{ ampulla_free_text | capfirst }}.{% endif %}{%\
    \ endif %}\n\n{% if ampullectomy_performed %}\nAfter a submucosal lift{% if snare_size_mm\
    \ | sku and snare_size_mm > 0 %}, a {{ snare_size_mm }} mm snare{% else %}, a\
    \ snare{% endif %} was used to perform ampullectomy. Resection was performed {%\
    \ if resection_style | sku and resection_style not in ['none', 'unknown'] %}{{\
    \ resection_style | replace('_', ' ') }}{% endif %}{% if energy_settings | sku\
    \ and energy_settings != 'not specified' %} using electrocautery {{ energy_settings\
    \ }}{% endif %}. The specimen was retrieved {% if specimen_retrieval_method |\
    \ sku and specimen_retrieval_method != 'not specified' %}{{ specimen_retrieval_method\
    \ }}{% endif %} and sent for histopathology. The resection base and margins were\
    \ carefully inspected; {% if resection_base_assessment | sku %}{{ resection_base_assessment\
    \ }}{% endif %}.{% if ampullectomy_hemostasis_method | sku and ampullectomy_hemostasis_method\
    \ != 'none' %} Hemostasis was achieved with {{ ampullectomy_hemostasis_method\
    \ }}.{% endif %}\n{% endif %}\n\n{% set _bile %}\n{% if sphincterotome_type |\
    \ sku or guidewire_type | sku %}\nBile duct cannulation was attempted using a\
    \ sphincterotome{% if sphincterotome_type | sku %} ({{ sphincterotome_type }}){%\
    \ endif %} preloaded with a guidewire{% if guidewire_type | sku %} ({{ guidewire_type\
    \ }}){% endif %}.{% endif %}\n{% if bile_duct_cannulation_successful %}\nBile\
    \ duct cannulation was successful. {% if bile_duct_cannulation_difficulty | sku\
    \ %}{{ bile_duct_cannulation_difficulty | sent }}{% endif %}{% if advanced_cannulation_techniques\
    \ | sku and advanced_cannulation_techniques != 'none' %} Cannulation achieved\
    \ via {{ advanced_cannulation_techniques }}.{% endif %}\n{% else %}Bile duct cannulation\
    \ was unsuccessful.\n  {% if bile_duct_cannulation_difficulty | sku %} {{ bile_duct_cannulation_difficulty\
    \ | sent }}{% endif %}\n  {% if advanced_cannulation_techniques | sku and advanced_cannulation_techniques\
    \ != 'none' %} {{ advanced_cannulation_techniques | capfirst }} was performed\
    \ {% endif %}\n  {% if rendezvous_attempted %}{% if rendezvous_result | sku %}\
    \ EUS-guided rendezvous was performed and was {{ rendezvous_result }}.{% else\
    \ %} Rendezvous was planned.{% endif %}\n  {% else %} The procedure was terminated.{%\
    \ endif %}{% endif %}\n{% endset %}\n{{ _bile | replace('\\n', ' ') | replace('\
    \ ', ' ') | trim }}\n\n{% set attempt = pancreatic_duct_cannulation_attempted\
    \ | default('') | sku %}\n{% if attempt == 'intentional' %}\nPancreatic duct cannulation\
    \ was attempted.{% if pancreatic_duct_cannulation_success %} Pancreatic duct was\
    \ selectively cannulated{% if pancreatic_duct_cannulation_technique | sku %} with\
    \ {{ pancreatic_duct_cannulation_technique }}{% endif %}.{% else %} Cannulation\
    \ was unsuccessful.{% endif %}\n{% elif attempt == 'not_attempted_inadvertent'\
    \ %}\nPancreatic duct cannulation was not attempted but was inadvertently cannulated.\n\
    {% endif %}\n{% if biliary_rendezvous_route | sku and biliary_rendezvous_route\
    \ != 'not applicable' %} {{ biliary_rendezvous_route | capfirst }} puncture was\
    \ performed.{% endif %}\n\n{% set _chol %}\n{% if contrast_injection_performed\
    \ %}\nContrast was injected under fluoroscopic guidance and cholangiogram was\
    \ performed.\n{% if cbd_diameter_mm | sku and cbd_diameter_mm > 0 %}The common\
    \ bile duct (CBD) measured {{ cbd_diameter_mm }} mm{% if cbd_diameter_mm >= 6\
    \ and cbd_diameter_mm <= 10 %} and was normal{% endif %}.{% endif %}\n{% if ihd_status\
    \ | sku and ihd_status not in ['unknown', 'none'] %} Intrahepatic ducts were {{\
    \ ihd_status | replace('_', ' ') }}{% if ihd_status == 'normal' %} in caliber,\
    \ and contrast drained freely into the duodenum{% endif %}.{% endif %}\n{% if\
    \ stone_description | sku and stone_description != 'none' %} {{ stone_description\
    \ | sent }}{% endif %}\n{% if stricture_description | sku and stricture_description\
    \ != 'none' %} {{ stricture_description | sent }}{% endif %}\n{% if non_stone_filling_defects\
    \ | sku %} {{ non_stone_filling_defects | sent }}{% endif %}\n{% if bile_leak_location\
    \ | sku and bile_leak_location != 'none' %} Contrast extravasation from the {{\
    \ bile_leak_location }} consistent with a bile leak.{% endif %}\n{% if prior_stent_status\
    \ | sku and prior_stent_status != 'none' %} {{ prior_stent_status | sent }}{%\
    \ endif %}\n{% if cholangiogram_free_text | sku and cholangiogram_free_text !=\
    \ 'none' %} {{ cholangiogram_free_text | sent }}{% endif %}\n{% else %}\n  Contrast\
    \ injection was not performed.\n{% endif %}\n{% endset %}\n{{ _chol | replace('\\\
    n', ' ') | replace('  ', ' ') | replace('  ', ' ') | trim }}\n\n{% if pancreatogram_obtained\
    \ %}\nPancreatogram was obtained{% if pancreatogram_overall | sku %} and {{ pancreatogram_overall\
    \ }} identified{% endif %}.\n{% if (main_pd_diameter_head_mm | sku and main_pd_diameter_head_mm\
    \ > 0) or (main_pd_diameter_body_mm | sku and main_pd_diameter_body_mm > 0) or\
    \ (main_pd_diameter_tail_mm | sku and main_pd_diameter_tail_mm > 0) %} Main PD\
    \ diameter was{% if main_pd_diameter_head_mm | sku and main_pd_diameter_head_mm\
    \ > 0 %} {{ main_pd_diameter_head_mm }} mm at head{% endif %}{% if main_pd_diameter_body_mm\
    \ | sku and main_pd_diameter_body_mm > 0 %}{% if main_pd_diameter_head_mm | sku\
    \ and main_pd_diameter_head_mm > 0 %},{% endif %} {{ main_pd_diameter_body_mm\
    \ }} mm at body{% endif %}{% if main_pd_diameter_tail_mm | sku and main_pd_diameter_tail_mm\
    \ > 0 %}{% if (main_pd_diameter_head_mm | sku and main_pd_diameter_head_mm > 0)\
    \ or (main_pd_diameter_body_mm | sku and main_pd_diameter_body_mm > 0) %},{% endif\
    \ %} {{ main_pd_diameter_tail_mm }} mm at tail{% endif %}.{% endif %}\n{% if side_branch_status\
    \ | sku and side_branch_status not in ['unknown', 'none'] %} Side branches were\
    \ {{ side_branch_status }}.{% endif %}\n{% if pd_stricture_location | sku and\
    \ pd_stricture_location != 'none' %} Stricture was located at {{ pd_stricture_location\
    \ }}.{% endif %}\n{% if pd_pseudocyst_communication | sku %} There was {% if not\
    \ pd_pseudocyst_communication %}no {% endif %}communication with pseudocyst.{%\
    \ endif %}\n{% endif %}\n\n{% if sphincterotomy_type | sku and sphincterotomy_type\
    \ != 'none' %}\n{% set ns = namespace(parts=[]) %}\n{# base sentence: mention\
    \ sphincterotomy and optional instrument #}\n{% set base = 'Sphincterotomy was\
    \ performed' %}\n{% if sphincterotome_used | sku %}\n  {% set base = base ~ '\
    \ using a ' ~ (sphincterotome_used) %}\n{% endif %}\n{% set base = base ~ '.'\
    \ %}\n{% set ns.parts = ns.parts + [base] %}\n\n{# optional incision details:\
    \ direction, extent, and goal #}\n{% if incision_direction | sku %}\n  {% set\
    \ clause = 'The incision was directed toward the ' ~ incision_direction ~ ' position'\
    \ %}\n  {% if sphincterotomy_extent | sku and sphincterotomy_extent != 'none'\
    \ %}\n    {% set clause = clause ~ ' and extended to a ' ~ sphincterotomy_extent\
    \ ~ ' papillotomy' %}\n    {% if sphincterotomy_goal_achieved | sku %}\n     \
    \ {% set clause = clause ~ ' until ' ~ sphincterotomy_goal_achieved ~ ' was achieved'\
    \ %}\n    {% endif %}\n  {% endif %}\n  {% set clause = clause ~ '.' %}\n  {%\
    \ set ns.parts = ns.parts + [clause] %}\n{% endif %}\n\n{{ ns.parts | join(' ')\
    \ }}\n{% endif %}\n\n{% set ns = namespace(parts=[]) %}\n{% if biliary_stent_type\
    \ == 'plastic' %}\n  {% set sentence = 'A ' %}\n  {% if plastic_biliary_type |\
    \ sku %}\n    {% set sentence = sentence ~ plastic_biliary_type ~ ' ' %}\n  {%\
    \ endif %}\n  {% set sentence = sentence ~ 'plastic biliary stent' %}\n  {% if\
    \ plastic_biliary_size | sku %}\n    {% set sentence = sentence ~ ' of ' ~ plastic_biliary_size\
    \ %}\n  {% endif %}\n  {% if plastic_biliary_length | sku and plastic_biliary_length\
    \ > 0 %}\n    {% set sentence = sentence ~ ' by ' ~ plastic_biliary_length ~ '\
    \ cm' %}\n  {% endif %}\n  {% set sentence = sentence ~ ' was placed.' %}\n{%\
    \ set ns.parts = ns.parts + [sentence] %}\n{% endif %}\n\n{% if biliary_stent_type\
    \ == 'metal' %}\nA {{ metal_biliary_type }} metal biliary stent\n{% if metal_biliary_length\
    \ | sku and metal_biliary_length > 0 %} of length {{ metal_biliary_length }} mm{%\
    \ endif %}\nwas placed.\n{% if metal_biliary_narrative | sku %}\n{{ metal_biliary_narrative\
    \ }}\n{% endif %}\n{% endif %}\n\n{% if pd_stent_placed %}\n{% set ns = namespace(parts=[])\
    \ %}\n\n{% if pd_stent_purpose == 'pep_prophylaxis' %}\n{% set base = 'A ' ~ pd_stent_size\
    \ ~ ' ' ~ pd_stent_type ~ ' stent was placed for PEP prophylaxis.' %}\n{% elif\
    \ pd_stent_purpose == 'therapeutic' %}\n  {% set base = 'A ' ~ pd_stent_size ~\
    \ ' ' ~ pd_stent_type ~ ' stent was placed for therapeutic purposes.' %}\n{% else\
    \ %}\n  {% set base = 'Pancreatic duct stent was placed.' %}\n{% endif %}\n{%\
    \ set ns.parts = ns.parts + [base] %}\n\n{% if pd_stent_purpose == 'therapeutic'\
    \ and pd_stent_therapy_flaps | sku and pd_stent_therapy_narrative | sku %}\n \
    \ {% set therapy_clause = 'The stent had ' ~ pd_stent_therapy_flaps ~ ' internal\
    \ flap(s). ' ~ pd_stent_therapy_narrative %}\n  {% set ns.parts = ns.parts + [therapy_clause]\
    \ %}\n{% endif %}\n\n{% if pd_placement_narrative | sku %}\n  {% set ns.parts\
    \ = ns.parts + [pd_placement_narrative] %}\n{% endif %}\n\n{{ ns.parts | join('\
    \ ') }}\n{% endif %}\n\nThe scope was then completely withdrawn from the patient\
    \ and the procedure completed.\n\n{% if estimated_blood_loss | sku and estimated_blood_loss\
    \ > 0 %}\nEstimated blood loss: {{ estimated_blood_loss }} ml.\n{% elif estimated_blood_loss\
    \ | sku and estimated_blood_loss == 0 %}\nEstimated blood loss: None.\n{% endif\
    \ %}\n\n{% if specimens_removed | sku and specimens_removed != 'none' %}\nSpecimens\
    \ removed: Specimens were optained. {{ specimens_removed | sent }}\n{% elif specimens_removed\
    \ == 'none' %}\nSpecimens removed: None.\n{% endif %}\n\n{% if complications |\
    \ sku and complications != 'none' %}\nComplications: {{ complications | sent }}\n\
    {% elif complications == 'none' %}\nComplications: There were no immediate complications.\n\
    {% endif %}"
  impressions: '{{ impressions }}'
  recommendations: '{{ recommendations }}'
